---
- name: Configure router
  hosts: router
  become: true
  tasks:
    - name: Enable IP forwarding
      ansible.posix.sysctl:
        name: net.ipv4.ip_forward
        value: '1'
        state: present
    - name: Ensure iptables-persistent is installed
      ansible.builtin.apt:
        name: iptables-persistent
        state: present
      environment:
        DEBIAN_FRONTEND: noninteractive
    - name: Ensure NAT for bank-net is configured
      ansible.posix.iptables:
        table: nat
        chain: POSTROUTING
        source: 10.0.1.0/24
        out_interface: eth2
        jump: MASQUERADE
        state: present
    - name: Persist iptables rules
      community.general.iptables_state:
        state: saved
        path: /etc/iptables/rules.v4

- name: Configure bank web server
  hosts: bank-web
  become: true
  tasks:
    - name: Install Apache2
      ansible.builtin.apt:
        update_cache: true
        name: apache2
        state: present
    - name: Deploy banking portal page
      ansible.builtin.copy:
        dest: /var/www/html/index.html
        content: "<h1>Welcome to Online Banking</h1><p>Secure login portal.</p>"
        mode: '0644'

- name: Configure bank database
  hosts: bank-db
  become: true
  tasks:
    - name: Install MariaDB
      ansible.builtin.apt:
        update_cache: true
        name: mariadb-server
        state: present
    - name: Allow remote DB access
      ansible.builtin.lineinfile:
        path: /etc/mysql/mariadb.conf.d/50-server.cnf
        regexp: '^bind-address'
        line: 'bind-address = 0.0.0.0'

- name: Install and configure RITA
  hosts: rita-server
  become: true
  tasks:
    - name: Install RITA
      ansible.builtin.apt:
        update_cache: true
        name: rita
        state: present
    - name: Ensure RITA service is running
      ansible.builtin.service:
        name: rita
        state: started
        enabled: true

- name: Remove UFW from all hosts
  hosts: all
  become: true
  tasks:
    - name: Remove UFW firewall
      ansible.builtin.apt:
        name: ufw
        state: absent
