---
- name: Configure router
  hosts: router
  become: true
  tasks:
    - name: Enable IP forwarding
      ansible.posix.sysctl:
        name: net.ipv4.ip_forward
        value: '1'
        state: present
    - name: Set up NAT for bank-net
      ansible.builtin.command: >
        iptables -t nat -A POSTROUTING -s 10.0.1.0/24 -o eth2 -j MASQUERADE
      changed_when: false
    - name: Set up NAT for ics-net
      ansible.builtin.command: >
        iptables -t nat -A POSTROUTING -s 10.0.2.0/24 -o eth2 -j MASQUERADE
      changed_when: false

- name: Configure bank web server
  hosts: bank-web
  become: true
  tasks:
    - name: Install Apache2
      ansible.builtin.apt:
        update_cache: true
        name: apache2
        state: present
    - name: Deploy banking portal page
      ansible.builtin.copy:
        dest: /var/www/html/index.html
        content: "<h1>Welcome to Online Banking</h1><p>Secure login portal.</p>"
        mode: '0644'

- name: Configure bank database
  hosts: bank-db
  become: true
  tasks:
    - name: Install MariaDB
      ansible.builtin.apt:
        update_cache: true
        name: mariadb-server
        state: present
    - name: Allow remote DB access
      ansible.builtin.lineinfile:
        path: /etc/mysql/mariadb.conf.d/50-server.cnf
        regexp: '^bind-address'
        line: 'bind-address = 0.0.0.0'

- name: Configure substation RTU
  hosts: substation-rtu
  become: true
  tasks:
    - name: Install netcat for ICS port simulation
      ansible.builtin.apt:
        update_cache: true
        name: netcat-openbsd
        state: present
    - name: Deploy netcat listener service
      ansible.builtin.template:
        src: templates/nc-listener@.service.j2
        dest: /etc/systemd/system/nc-listener@.service
        mode: '0644'
    - name: Reload systemd to pick up nc listener unit
      ansible.builtin.systemd:
        daemon_reload: true
    - name: Ensure Modbus service listening on port 502
      ansible.builtin.service:
        name: nc-listener@502
        state: started
        enabled: true
    - name: Ensure S7comm service listening on port 102
      ansible.builtin.service:
        name: nc-listener@102
        state: started
        enabled: true

- name: Remove UFW from all hosts
  hosts: all
  become: true
  vars_files:
    - vars/users.yml
  tasks:
    - name: Remove UFW firewall
      ansible.builtin.apt:
        name: ufw
        state: absent
    - name: Create User
      ansible.builtin.user:
        name: debian
        password: "{{ debian_user_password_hash }}"
        update_password: on_create
        state: present
    - name: Give sudo privileges
      ansible.builtin.copy:
        dest: /etc/sudoers.d/debian
        content: "debian ALL=(ALL) /usr/bin/apt-get, /usr/bin/systemctl"
        mode: '0440'
        validate: 'visudo -cf %s'
